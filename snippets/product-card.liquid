{%- doc -%}
  This snippet is used to render a product card.
  It is used in the product block, featured product block, and the product card block.
  The product object is null or when placeholders are rendered.

  @param {object} product - The product object
  @param {object} children - The children of the product card
  @param {object} [block] - The block object
  @param {number} [product_card_gap] - The gap between the product card children (overrides block settings)
{%- enddoc -%}

{% assign block_settings = block.settings %}

{% style %}
  {% if request.visual_preview_mode %}
    product-card-link {
      width: 100%;
      min-width: 250px;
    }
  {% endif %}
{% endstyle %}

{% liquid
  assign has_quick_add = false
  if settings.quick_add and product.available
    assign has_quick_add = true
  endif

  assign has_mobile_quick_add = false
  if has_quick_add and settings.mobile_quick_add
    assign has_mobile_quick_add = true
  endif

  assign product_card_id = 'product-card-link-' | append: block.id | append: '-' | append: product.id
  assign product_card_gap_value = product_card_gap | default: block_settings.product_card_gap

  # Logic to determine which variant URL to use (matching swatch selection logic)
  assign variant_to_link = product.selected_or_first_available_variant

  if settings.transition_to_main_product
    assign featured_image = variant_to_link.featured_image
    if featured_image == blank
      assign featured_image = product.featured_media.preview_image
    endif

    if featured_image != blank
      assign featured_media_url = featured_image | image_url: width: 500
    endif
  endif

  assign onboarding = false
  if product.id == empty or product == blank
    assign onboarding = true
  endif
%}

{%- if settings.transition_to_main_product -%}
  <product-card-link
    data-product-id="{{ product.id }}"
    data-featured-media-url="{{ featured_media_url }}"
    data-product-transition="{{ settings.transition_to_main_product }}"
    {% if onboarding %}
      data-placeholder="true"
    {% endif %}
  >
{%- endif -%}
<product-card
  class="product-card"
  data-product-id="{{ product.id }}"
  id="product-card-{{ block.id }}"
  data-product-transition="{{ settings.transition_to_main_product }}"
  {{ block.shopify_attributes }}
  {% if onboarding %}
    data-placeholder="true"
  {% endif %}
>
  <a
    id="{{ product_card_id | md5 }}"
    {% unless onboarding %}
      href="{{ variant_to_link.url }}"
    {% endunless %}
    class="product-card__link"
    ref="productCardLink"
  >
    <span class="visually-hidden">
      {{ product.title }}
    </span>
  </a>
  <div
    class="
      product-card__content
      layout-panel-flex
      layout-panel-flex--column
      product-grid__card
      spacing-style
      border-style
      gap-style
      {% if block_settings.inherit_color_scheme == false %} color-{{ block_settings.color_scheme }}{% endif %}
    "
    style="
      {% render 'border-override', settings: block_settings %}
      {% render 'layout-panel-style', settings: block_settings %}
      {% render 'spacing-style', settings: block_settings %}
      {% render 'gap-style', value: product_card_gap_value, name: 'product-card-gap' %}
      --quick-add-display: {% if has_quick_add %}flex{% else %}none{% endif %};
      --quick-add-mobile-display: {% if has_mobile_quick_add %}flex{% else %}none{% endif %};
      --quick-add-mobile-opacity: {% if has_mobile_quick_add %}1{% else %}0{% endif %};
      {% if block_settings.padding-inline-start > 0 %}--zoom-out-padding-inline-start: min(var(--padding-xs), {{ block_settings.padding-inline-start | times: 0.7}}px);{% endif %}
      {% if block_settings.padding-inline-end > 0 %}--zoom-out-padding-inline-end: min(var(--padding-xs), {{ block_settings.padding-inline-end | times: 0.7}}px);{% endif %}
      {% if block_settings.padding-block-start > 0 %}--zoom-out-padding-block-start: min(var(--padding-xs), {{ block_settings.padding-block-start | times: 0.7}}px);{% endif %}
      {% if block_settings.padding-block-end > 0 %}--zoom-out-padding-block-end: min(var(--padding-xs), {{ block_settings.padding-block-end | times: 0.7}}px);{% endif %}
    "
  >
    {%- if product.featured_media -%}
      <div class="kallos-card-media" style="position: relative; aspect-ratio: 1/1; overflow: hidden;">
         <img class="kallos-img kallos-img-main" 
              src="{{ product.featured_media | image_url: width: 600 }}" 
              loading="lazy" alt="{{ product.title }}"
              style="width: 100%; height: 100%; object-fit: cover;">
         
         {%- if product.media[1] -%}
           <img class="kallos-img-hover" 
                src="{{ product.media[1] | image_url: width: 600 }}" 
                loading="lazy" alt="{{ product.title }}"
                style="position: absolute; inset: 0; opacity: 0; transition: 0.4s; width: 100%; height: 100%; object-fit: cover;">
         {%- endif -%}
      </div>
    {%- endif -%}

    <div class="kallos-card-content-wrapper" style="padding: 20px; color: #fff;">
      <div class="kallos-card-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
        <p class="kallos-card-title" style="margin: 0; font-weight: 700;">{{ product.title }}</p>
        <span class="kallos-card-price" style="font-weight: 700;">{{ product.price | money }}</span>
      </div>

      <div class="kallos-card-description" style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
        {{ product.description | strip_html | truncatewords: 15 }}
      </div>

      <div class="kallos-static-stars" style="display: flex; gap: 2px;">
        {% for i in (1..5) %}
          <svg class="kallos-star-svg" viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: #fff;"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        {% endfor %}
      </div>
    </div>

    {%- comment -%} 
      Mantenemos esto al final por si activas botones de "Comprar" 
      o "Elegir opciones" desde el personalizador de Shopify 
    {%- endcomment -%}
    <div class="product-card__footer">
       {{ children }}
    </div>
  </div>
</product-card>
{%- if settings.transition_to_main_product -%}
  </product-card-link>
{%- endif -%}

{% stylesheet %}
  product-card-link,
  :not(product-card-link) product-card {
    width: 100%;
  }

  .product-card__placeholder-image svg {
    height: 100%;
  }

  @media screen and (max-width: 749px) {
    .product-card slideshow-arrows .slideshow-control {
      display: none;
    }
  }

  /* Hide "Add" button when "Choose" button is shown */
  [data-quick-add-button='choose'] add-to-cart-component {
    display: none;
  }

  /* Hide "Choose" button when "Add" button is shown */
  [data-quick-add-button='add'] .quick-add__button--choose {
    display: none;
  }
{% endstylesheet %}
